
  <!DOCTYPE html>
  <html>
  
  <head>
      <meta charset="utf-8" />
      <title>
          Zrek's blog
      </title>
      <style>
      li {
        cursor:pointer;
      }
      
      li:hover{
        background-color: #ffffff99;
      }
      
      code{
        background-color: #eee;
        padding:2px;
        display:inline-block;
      }
      
      pre{
        background-color: #eee;
        padding:10px;
        padding-left: 20px;
        padding-right: 20px;
      }
      </style>
  </head>
  
  <body style="background:#f7f7f7;">
      <div style="display:flex;width:100%;">
          <div>Zrek's blog</div>
      </div>
      <div style="display:flex;width:100%;">
          <div id="category" style="display: flex; flex-direction:column;background-color: antiquewhite; padding-right:20px; flex-shrink:0;">
          <ul><li onclick="location.href='../cs/0依赖创造一个语言跑起来.html';">0依赖创造一个语言跑起来</li><li onclick="location.href='../cs/Activity启动模式理解.html';">Activity启动模式理解</li><li onclick="location.href='../cs/ConcurrentHashMap理解.html';">ConcurrentHashMap理解</li><li onclick="location.href='../cs/Dex文件理解.html';">Dex文件理解</li><li onclick="location.href='../cs/Github&Gitlab-CI&CD理解.html';">Github&Gitlab-CI&CD理解</li><li onclick="location.href='../cs/Glide理解.html';">Glide理解</li><li onclick="location.href='../cs/HashMap理解.html';">HashMap理解</li><li onclick="location.href='../cs/JVM内存模型.html';">JVM内存模型</li><li onclick="location.href='../cs/Java内存模型(JMM).html';">Java内存模型(JMM)</li><li onclick="location.href='../cs/Java动态代码生成方案理解.html';">Java动态代码生成方案理解</li><li onclick="location.href='../cs/Java并发概述.html';">Java并发概述</li><li onclick="location.href='../cs/Js dev.html';">Js dev</li><li onclick="location.href='../cs/Kotlin语法糖理解.html';">Kotlin语法糖理解</li><li onclick="location.href='../cs/LinkedHashMap理解.html';">LinkedHashMap理解</li><li onclick="location.href='../cs/MMKVl理解.html';">MMKVl理解</li><li onclick="location.href='../cs/MultiDex理解.html';">MultiDex理解</li><li onclick="location.href='../cs/React理解.html';">React理解</li><li onclick="location.href='../cs/RxJava理解.html';">RxJava理解</li><li onclick="location.href='../cs/TreeMap理解.html';">TreeMap理解</li><li onclick="location.href='../cs/binder ipc原理.html';">binder ipc原理</li><li onclick="location.href='../cs/dagger2.html';">dagger2</li><li onclick="location.href='../cs/index.html';">index</li><li onclick="location.href='../cs/js engines.html';">js engines</li><li onclick="location.href='../cs/knowledge tree.html';">knowledge tree</li><li>pics<ul></ul></li><li onclick="location.href='../cs/rust.html';">rust</li><li onclick="location.href='../cs/v2.html';">v2</li><li onclick="location.href='../cs/volatile理解.html';">volatile理解</li><li onclick="location.href='../cs/吉他指型推导.html';">吉他指型推导</li><li onclick="location.href='../cs/手写React Native.html';">手写React Native</li><li onclick="location.href='../cs/插件化方案理解.html';">插件化方案理解</li><li>操作系统<ul><li onclick="location.href='../cs/操作系统/多任务操作系统.html';">多任务操作系统</li></ul></li><li onclick="location.href='../cs/构建优化.html';">构建优化</li><li>测试<ul><li onclick="location.href='../cs/测试/MockResponse来进行AndroidTest.html';">MockResponse来进行AndroidTest</li><li onclick="location.href='../cs/测试/内存泄漏测试.html';">内存泄漏测试</li></ul></li><li onclick="location.href='../cs/热修复方案理解.html';">热修复方案理解</li><li onclick="location.href='../cs/第三方面试整理.html';">第三方面试整理</li><li onclick="location.href='../cs/算法整理.html';">算法整理</li><li onclick="location.href='../cs/补码运算.html';">补码运算</li><li onclick="location.href='../cs/计算机网络.html';">计算机网络</li></ul>
          </div>
          <div id="reader" style="display: flex; flex-direction:column;flex-grow: 1; padding:20px">
          <h1>
<a id="user-content-mmkv理解" class="anchor" href="#mmkv%E7%90%86%E8%A7%A3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MMKV理解</h1>
<p><a href="https://github.com/Tencent/MMKV/wiki/android_ipc">多进程</a></p>
<h2>
<a id="user-content-mmkv原理mmap--文件锁--protobuffer" class="anchor" href="#mmkv%E5%8E%9F%E7%90%86mmap--%E6%96%87%E4%BB%B6%E9%94%81--protobuffer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MMKV原理（mmap + 文件锁 + ProtoBuffer）</h2>
<p>使用文件内存映射（mmap），由Linux系统负责什么时候把内存数据写回到文件。采取此方式可以避免其他所有方式在多进程条件下，可能出现的死锁、饿死问题，即持有锁的进程被kill的时候，其他进程无限等待。按原文所说，binder也采取了文件描述符所生成的锁（<strong>文件锁</strong>）解决多进程问题。</p>
<h2>
<a id="user-content-相比于其他多进程方案" class="anchor" href="#%E7%9B%B8%E6%AF%94%E4%BA%8E%E5%85%B6%E4%BB%96%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%96%B9%E6%A1%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>相比于其他多进程方案</h2>
<ul>
<li>SharePreference不支持多进程，没有任何机制、措施可以确保多进程同步。</li>
<li>按MMKV文档介绍，ContentProvider一个单独进程管理数据，但是启动慢、访问慢。其他socket, pipe, message queue要至少2次内存拷贝。</li>
</ul>
<h2>
<a id="user-content-数据同步写数据内存重整内存扩容" class="anchor" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%86%99%E6%95%B0%E6%8D%AE%E5%86%85%E5%AD%98%E9%87%8D%E6%95%B4%E5%86%85%E5%AD%98%E6%89%A9%E5%AE%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>数据同步（写数据、内存重整、内存扩容）</h2>
<p>写数据时，所有的新数据以ProtoBuffer形式编码，追加（append）到当前的写指针上。因此内存会变大。即使是相同的key，也是追加的方式。内存的尺寸（分有效尺寸和文件尺寸）会被写入在文件的头部。</p>
<p>内存重整，依然是通过文件头部存储一个递增的序列号，通过比较进程缓存的序列号和文件头部的序列号，即可知道是否发生了内存重整。</p>
<p>内存扩容，在扩容前必先会触发内存重整。而扩容后内存的文件尺寸会变大，进程通过对比缓存的文件尺寸跟当前的文件尺寸即可判断。</p>
<p>进程首先通过对比缓存的序号和当前文件序号是否一致，若不一致，则看缓存的文件大小和当前的是否一致，若不一致则说明是文件扩容，否则只是内存重整。而这两者的处理方式都是完全重新解码覆盖到原来的map。而如果序号一致，只是文件的实际内存尺寸不同，则说明是增加了数据（即使key可以相同），那么则仅把尺寸增加的部分内存取出解码成map，然后遍历覆盖原来的map即可。</p>
<h2>
<a id="user-content-写入优化" class="anchor" href="#%E5%86%99%E5%85%A5%E4%BC%98%E5%8C%96" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>写入优化</h2>
<p>使用ProtoBuffer为了更好的性能和更小的空间。（相比Json, xml）</p>
<h2>
<a id="user-content-onemorething-单进程下vs-sharepreference" class="anchor" href="#onemorething-%E5%8D%95%E8%BF%9B%E7%A8%8B%E4%B8%8Bvs-sharepreference" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>OneMoreThing 单进程下vs SharePreference</h2>
<p>sp使用了很多synchronize代码块（不是直接修饰方法），来确保多线程同步。此外，apply和commit分别异步/同步把变更写回到文件。</p>

          </div>
      </div>
  </body>
  
  </html>
    